name: Build Tokenvator

on:
  push:
    branches: ["main", "master"]
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: üßæ Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install .NET Framework 4.5 Developer Pack
        run: |
            Invoke-WebRequest -Uri https://download.microsoft.com/download/2/7/D/27DAB2A2-581C-4D1F-B3B8-2CFE3A4F8BB2/NDP45-DevPack-KB2872776-ENU.exe -OutFile devpack.ex
            Start-Process .\devpack.exe -ArgumentList "/quiet" -Wait
            Remove-Item .\devpack.exe
        shell: powershell


      - name: Setup NuGet CLI
        uses: NuGet/setup-nuget@v1

      - name: Restore NuGet packages
        run: |
          nuget restore Tokenvator.sln

      - name: Install MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Build Tokenvator (Release)
        run: |
          msbuild Tokenvator.csproj /p:Configuration=Release-Net45 /p:Platform="x64"

      - name: üìÅ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tokenvator-release
          path: |
            Tokenvator/Tokenvator/bin/Release-Net45/
            
      - name: üîê Compress and Base64-encode Koh.exe
        shell: powershell
        run: |
          $exePath = "Koh\\bin\\Release\\Koh.exe"
          $b64Out = "Koh\\bin\\Release\\KohB64.txt"

          $bytes = [System.IO.File]::ReadAllBytes($exePath)
          $outStream = New-Object System.IO.MemoryStream
          $gzipStream = New-Object System.IO.Compression.GzipStream($outStream, [System.IO.Compression.CompressionMode]::Compress)

          $gzipStream.Write($bytes, 0, $bytes.Length)
          $gzipStream.Close()
          $outStream.Close()

          $outBytes = $outStream.ToArray()
          $b64Zipped = [System.Convert]::ToBase64String($outBytes)

          Set-Content -Path $b64Out -Value $b64Zipped -Encoding ASCII -NoNewline

      - name: ‚òÅÔ∏è Upload base64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: koh-b64
          path: Koh/bin/Release/KohB64.txt
